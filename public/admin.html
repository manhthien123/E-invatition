<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản trị tài liệu họp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-slate-100 p-4 md:p-8 font-sans">
        <div class="flex justify-end p-4">
        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold shadow transition">
            <i class="fa-solid fa-right-from-bracket"></i> ĐĂNG XUẤT
        </div>
    </div>
    <div class="max-w-4xl mx-auto space-y-6">
        
        <div class="bg-gradient-to-r from-blue-700 to-blue-900 p-6 rounded-2xl shadow-xl text-white">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-link"></i> QUẢN LÝ ĐƯỜNG DẪN CUỘC HỌP
            </h2>
            <div class="flex flex-wrap gap-4 items-end">
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-xs font-bold mb-1 opacity-80 uppercase">Mã ID cuộc họp:</label>
                    <input id="currentID" type="text" placeholder="Gõ ID hoặc bấm Tạo mới..." 
                           class="w-full p-2.5 rounded-lg bg-white/20 border border-white/30 text-white font-mono font-bold outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <button onclick="createNewMeeting()" class="bg-green-500 hover:bg-green-600 px-6 py-2.5 rounded-lg font-bold transition shadow-md">
                    TẠO MỚI
                </button>
                <button onclick="copyMeetingLink()" class="bg-white/10 hover:bg-white/20 px-6 py-2.5 rounded-lg font-bold transition border border-white/30">
                    COPY LINK
                </button>
            </div>
            <p id="shareLink" class="mt-3 text-sm text-blue-200 font-medium italic"></p>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-pen-to-square text-blue-500"></i> Nội dung cuộc họp
            </h3>
            <div class="grid grid-cols-1 gap-4">
                <input id="title" type="text" placeholder="Chương trình/Tiêu đề họp" class="w-full border p-2.5 rounded-lg outline-none focus:border-blue-500">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input id="time" type="text" placeholder="Thời gian (VD: 08:00 - 02/02/2026)" class="w-full border p-2.5 rounded-lg">
                    <input id="location" type="text" placeholder="Địa điểm" class="w-full border p-2.5 rounded-lg">
                </div>
                <textarea id="members" placeholder="Thành phần tham dự..." rows="2" class="w-full border p-2.5 rounded-lg"></textarea>
                <button onclick="updateInfo()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">
                    CẬP NHẬT THÔNG TIN CHUNG
                </button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-file-arrow-up text-green-500"></i> Đăng tải tài liệu (PDF)
            </h3>
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <select id="category" class="border p-2.5 rounded-lg bg-slate-50">
                        <option value="Giấy mời họp">Giấy mời họp</option>
                        <option value="Tài liệu phiên họp">Tài liệu phiên họp</option>
                        <option value="Kết luận họp">Kết luận họp</option>
                        <option value="Tài liệu tham khảo">Tài liệu tham khảo</option>
                    </select>
                    <input id="displayName" type="text" placeholder="Tên văn bản hiển thị..." class="border p-2.5 rounded-lg">
                </div>
                <input id="fileInput" type="file" accept=".pdf" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <button onclick="uploadFile()" class="w-full bg-slate-800 hover:bg-black text-white font-bold py-3 rounded-lg transition uppercase tracking-wider">
                    Đăng tài liệu lên hệ thống
                </button>
            </div>

            <div class="mt-8 pt-6 border-t border-slate-100">
                <h4 class="text-sm font-bold text-slate-500 uppercase mb-4 tracking-widest">Tài liệu đã tải lên</h4>
                <div id="admin-file-list" class="space-y-3">
                    </div>
            </div>
    <div class="max-w-5xl mx-auto mt-10 bg-white rounded-2xl shadow-xl overflow-hidden border border-blue-100">
    <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
        <h2 class="font-bold uppercase tracking-wider flex items-center gap-2">
            <i class="fa-solid fa-list-ul text-blue-400"></i> Quản lý danh sách cuộc họp
        </h2>
        <button onclick="loadMeetingList()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded transition">
            <i class="fa-solid fa-rotate"></i> Làm mới
        </button>
    </div>
    
    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead class="bg-slate-50 border-b border-slate-100">
                <tr>
                    <th class="p-4 text-xs font-bold text-slate-500 uppercase">Tên cuộc họp</th>
                    <th class="p-4 text-xs font-bold text-slate-500 uppercase">Mã ID</th>
                    <th class="p-4 text-xs font-bold text-slate-500 uppercase text-center">Thao tác</th>
                </tr>
            </thead>
            <tbody id="meeting-list-body" class="divide-y divide-slate-50">
                <tr>
                    <td colspan="3" class="p-10 text-center text-slate-400 italic">Đang tải danh sách...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

        </div>
    </div>

    <script>
        // 1. Kiểm tra an ninh
        async function checkSecurity() {
            try {
                const res = await fetch('/api/data/check'); // Route giả định để check quyền
                if (res.status === 403 || res.status === 401) window.location.href = '/login.html';
            } catch (err) { /* Bỏ qua nếu chưa cài route check */ }
        }
        checkSecurity();

        // 2. Tạo ID mới
        async function createNewMeeting() {
            const res = await fetch('/api/create-meeting', { method: 'POST' });
            const result = await res.json();
            if (result.success) {
                document.getElementById('currentID').value = result.id;
                updateView(result.id);
                alert("Mã ID mới: " + result.id);
            }
        }

        // 3. Cập nhật giao diện khi có ID
        function updateView(id) {
            if (!id) return;
            const fullLink = window.location.origin + "/meeting/" + id;
            document.getElementById('shareLink').innerHTML = `Link khách: <a href="${fullLink}" target="_blank" class="underline">${fullLink}</a>`;
            loadMeetingData(id);
        }

        // 4. Tải dữ liệu từ ID
        async function loadMeetingData(id) {
            const res = await fetch(`/api/data/${id}`);
            if (!res.ok) { resetForm(); return; }
            const data = await res.json();
            
            document.getElementById('title').value = data.title || "";
            document.getElementById('time').value = data.time || "";
            document.getElementById('location').value = data.location || "";
            document.getElementById('members').value = data.members || "";
            
            renderFiles(data.files || [], id);
        }

        async function logout() {
            if (!confirm("Bạn có chắc chắn muốn đăng xuất không?")) return;

            try {
                const res = await fetch('/api/logout');
                const data = await res.json();

                if (data.success) {
                    // Đăng xuất xong thì đá về trang login ngay lập tức
                    window.location.href = '/login.html';
                } else {
                    alert("Lỗi khi đăng xuất!");
                }
            } catch (err) {
                console.error("Lỗi kết nối:", err);
                // Nếu server lỗi thì vẫn nên cho người dùng về trang login cho an toàn
                window.location.href = '/login.html';
            }
        }

        function renderFiles(files, id) {
            const list = document.getElementById('admin-file-list');
            list.innerHTML = files.map(f => {
                const fileName = f.path.split('/').pop();
                return `
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded-lg border border-slate-200 shadow-sm">
                    <span class="text-sm font-medium text-slate-700">${f.name} <span class="text-xs text-slate-400">(${f.category})</span></span>
                    <button onclick="deleteFile('${id}', '${fileName}')" class="text-red-500 hover:bg-red-50 px-3 py-1 rounded text-xs font-bold uppercase transition">Xóa</button>
                </div>`;
            }).join('');
        }

        // 5. Các hàm API chính
        async function updateInfo() {
            const id = document.getElementById('currentID').value;
            if(!id) return alert("Chưa có ID!");
            const data = {
                title: document.getElementById('title').value,
                time: document.getElementById('time').value,
                location: document.getElementById('location').value,
                members: document.getElementById('members').value
            };
            const res = await fetch(`/api/update-info/${id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if(res.ok) alert("Lưu thành công!");
        }

        async function uploadFile() {
            const id = document.getElementById('currentID').value;
            const fileInput = document.getElementById('fileInput');
            if(!id || fileInput.files.length === 0) return alert("Thiếu ID hoặc File!");

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('category', document.getElementById('category').value);
            formData.append('displayName', document.getElementById('displayName').value);

            const res = await fetch(`/api/upload/${id}`, { method: 'POST', body: formData });
            if(res.ok) { alert("Đã đăng file!"); loadMeetingData(id); }
        }

        async function deleteFile(id, fileName) {
            if(!confirm("Xóa file này?")) return;
            const res = await fetch(`/api/delete-file/${id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ fileName })
            });
            if(res.ok) loadMeetingData(id);
        }

        function copyMeetingLink() {
            const id = document.getElementById('currentID').value;
            if(!id) return;
            const link = window.location.origin + "/meeting/" + id;
            navigator.clipboard.writeText(link);
            alert("Đã copy!");
        }

        function resetForm() {
            document.querySelectorAll('input:not(#currentID), textarea').forEach(i => i.value = "");
            document.getElementById('admin-file-list').innerHTML = "";
        }

        // 1. Hàm tải danh sách từ Server (Dùng API mới tạo ở server.js)
    async function loadMeetingList() {
    console.log("Đang bắt đầu tải danh sách..."); // Kiểm tra xem hàm có chạy không
    try {
        const res = await fetch('/api/meetings');
        
        // Kiểm tra nếu bị chặn quyền (Unauthorized)
        if (res.status === 403) {
            document.getElementById('meeting-list-body').innerHTML = 
                '<tr><td colspan="3" style="color:red; text-align:center; padding:20px;">⚠️ Lỗi: Bạn chưa đăng nhập. Hãy quay lại trang Login.</td></tr>';
            return;
        }

        const meetings = await res.json();
        console.log("Dữ liệu nhận được:", meetings); // Xem dữ liệu có bị rỗng [] không

        const tbody = document.getElementById('meeting-list-body');
        
        if (!meetings || meetings.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">Chưa có link nào được tạo.</td></tr>';
            return;
        }

        // Đổ dữ liệu vào bảng
        tbody.innerHTML = meetings.map(m => `
            <tr class="border-b hover:bg-gray-50 transition">
                <td class="p-4 text-gray-700 font-medium">${m.title || 'Không tên'}</td>
                <td class="p-4 text-gray-500 font-mono text-sm">${m.meetingId}</td>
                <td class="p-4">
                    <div class="flex gap-3">
                        <button onclick="copyLink('${m.meetingId}')" 
                                class="flex items-center gap-2 px-3 py-1.5 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors"
                                title="Sao chép đường dẫn">
                            <i class="fa-regular fa-copy"></i>
                            <span class="text-sm font-medium">Copy Link</span>
                        </button>

                        <button onclick="deleteMeeting('${m.meetingId}')" 
                                class="flex items-center gap-2 px-3 py-1.5 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors"
                                title="Xóa cuộc họp">
                            <i class="fa-regular fa-trash-can"></i>
                            <span class="text-sm font-medium">Xóa</span>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');

    } catch (err) {
        console.error("Lỗi Fetch:", err);
        document.getElementById('meeting-list-body').innerHTML = '<tr><td colspan="3">Lỗi kết nối server.</td></tr>';
    }
}

// Hàm copy link
function copyLink(id) {
    const link = window.location.origin + '/meeting/' + id;
    navigator.clipboard.writeText(link);
    alert("Đã copy: " + link);
}

// Gọi hàm khi tải trang
window.onload = loadMeetingList;

// 2. Hàm copy link nhanh
function copyMeetingLink(id) {
    const fullLink = `${window.location.origin}/meeting/${id}`;
    navigator.clipboard.writeText(fullLink);
    alert('✅ Đã copy link: ' + fullLink);
}

// 3. Hàm xóa cuộc họp
async function deleteMeeting(id) {
    if (!confirm(`⚠️ Bạn có chắc chắn muốn xóa cuộc họp [${id}]?\nTất cả tài liệu đính kèm sẽ không thể truy cập được nữa.`)) return;

    try {
        const res = await fetch(`/api/meeting/${id}`, { method: 'DELETE' });
        const result = await res.json();
        if (result.success) {
            loadMeetingList(); // Tải lại danh sách ngay lập tức
        } else {
            alert('Lỗi: ' + result.error);
        }
    } catch (err) {
        alert('Không thể kết nối server để xóa.');
    }
}

// 4. CẬP NHẬT: Sửa lại hàm tạo cuộc họp cũ của bạn
// Bạn tìm hàm createMeeting cũ và thêm loadMeetingList() vào cuối
async function createMeeting() {
    const res = await fetch('/api/create-meeting', { method: 'POST' });
    const data = await res.json();
    if (data.success) {
        alert('Tạo thành công ID: ' + data.id);
        loadMeetingList(); // <--- THÊM DÒNG NÀY ĐỂ CẬP NHẬT BẢNG
    }
}

// Tự động chạy khi mở trang
        document.addEventListener('DOMContentLoaded', loadMeetingList);
        document.getElementById('currentID').addEventListener('change', (e) => updateView(e.target.value));
    </script>
</body>
</html>